<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Samruddhi Enterprises — Cutting Plan</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <h1>Samruddhi Enterprises</h1>
    <p>SS Steel Pipe Cutting</p>
  </header>

  <main>
    <section class="card multi-form-card">
      <h2>Multi-size cutting plan</h2>
      <p class="multi-intro">Standard raw pipe: <strong>{{ standard_raw_mm|int }} mm</strong>. Enter cut sizes and quantities. Use + to add more rows.</p>
      <form method="post" action="/" class="multi-form" id="multi-form">
        <input type="hidden" name="multi_submit" value="1">
        <div class="multi-rows" id="multi-rows">
          <div class="multi-row multi-row-header">
            <span class="multi-col">Cut length (mm)</span>
            <span class="multi-col">Quantity</span>
          </div>
          <div class="multi-row"><input type="number" name="multi_cut_length" step="0.01" min="0" placeholder="e.g. 243" class="multi-input"><input type="number" name="multi_quantity" min="0" placeholder="0" class="multi-input"></div>
          <div class="multi-row"><input type="number" name="multi_cut_length" step="0.01" min="0" placeholder="e.g. 2342" class="multi-input"><input type="number" name="multi_quantity" min="0" placeholder="0" class="multi-input"></div>
          <div class="multi-row"><input type="number" name="multi_cut_length" step="0.01" min="0" placeholder="e.g. 1500" class="multi-input"><input type="number" name="multi_quantity" min="0" placeholder="0" class="multi-input"></div>
        </div>
        <div class="multi-form-actions">
          <button type="button" class="btn-add-row" id="btn-add-row" title="Add another requirement">+ Add row</button>
          <button type="submit" class="btn-multi">Generate cutting plan</button>
        </div>
      </form>
    </section>

    {% if multi_result and multi_result.pipes %}
    <section class="card multi-result-card">
      <h2>Multi-size result</h2>
      <p class="multi-summary">Pipes needed: <strong>{{ multi_result.total_pipes }}</strong> · Used (incl. kerf): <strong>{{ "%.2f"|format(multi_result.total_used) }} mm</strong> · Kerf loss: <strong>{{ "%.2f"|format(multi_result.total_kerf) }} mm</strong> · Total scrap: <strong>{{ "%.2f"|format(multi_result.total_scrap) }} mm</strong></p>
      <p class="multi-scrap-note">Scrap ≥ {{ scrap_threshold_mm|int }} mm is saved to inventory for future use; smaller pieces are not saved.</p>
      {% if multi_result.last_pipe_over_limit %}
      <p class="multi-last-pipe-warning">Last pipe has {{ "%.2f"|format(multi_result.pipes[-1].scrap) }} mm scrap (max 75 mm). Use one more raw pipe and re-run with the same requirements to meet the rule.</p>
      {% endif %}
      <div class="multi-pipes">
        {% for p in multi_result.pipes %}
        <div class="multi-pipe">
          <div class="multi-pipe-title">Pipe {{ p.pipe_number }}: {{ p.pipe_label }}</div>
          <div class="multi-pipe-cuts">Cuts: {% if p.cuts %}{% for c in p.cuts %}{{ "%.2f"|format(c) }}{% if not loop.last %} + {% endif %}{% endfor %}{% else %}— (none; use next pipe){% endif %}</div>
          <div class="multi-pipe-kerf">Kerf loss: 3 mm × {{ p.num_cuts }} = {{ "%.2f"|format(p.kerf_mm) }} mm</div>
          <div class="multi-pipe-used">Used: {{ "%.2f"|format(p.used) }} mm</div>
          <div class="multi-pipe-scrap">Scrap: {{ "%.2f"|format(p.scrap) }} mm ({{ p.scrap_class }})</div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    {% if inventory_suggestions %}
    <section class="card suggestion-card">
      <h2>Suggestion for next requirement</h2>
      <p class="suggestion-intro">Pieces in inventory that are {{ scrap_threshold_mm|int }} mm or longer can be used in a future plan. Add a requirement with cut length ≤ the piece size:</p>
      <ul class="suggestion-list">
        {% for row in inventory_suggestions %}
        <li><strong>{{ "%.2f"|format(row.length) }} mm</strong> — use for requirements ≤ {{ "%.2f"|format(row.length) }} mm</li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}

    <section class="card inventory-card">
      <h2>Leftover inventory</h2>
      {% if inventory %}
      <form method="post" action="{{ url_for('index') }}" class="clear-inventory-form" onsubmit="return confirm('Clear all leftover pieces from inventory? This cannot be undone.');">
        <input type="hidden" name="clear_inventory" value="1">
        <button type="submit" class="btn-clear-inventory">Clear all inventory</button>
      </form>
      <table class="inventory-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Length (mm)</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody>
          {% for row in inventory %}
          <tr>
            <td>{{ row.id }}</td>
            <td>{{ "%.2f"|format(row.length) }}</td>
            <td>{{ row.created_at[:19] if row.created_at else '—' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="inventory-summary">Total: {{ inventory|length }} piece{{ 's' if inventory|length != 1 else '' }} · {{ "%.2f"|format(inventory|sum(attribute='length')) }} mm</p>
      {% else %}
      <p class="empty">No leftover material.</p>
      {% endif %}
    </section>
  </main>
  <script>
    (function() {
      var btn = document.getElementById('btn-add-row');
      var container = document.getElementById('multi-rows');
      if (!btn || !container) return;
      btn.addEventListener('click', function() {
        var rows = container.querySelectorAll('.multi-row:not(.multi-row-header)');
        var last = rows[rows.length - 1];
        if (!last) return;
        var clone = last.cloneNode(true);
        clone.querySelectorAll('input').forEach(function(inp) { inp.value = ''; });
        container.appendChild(clone);
      });
    })();
  </script>
</body>
</html>
